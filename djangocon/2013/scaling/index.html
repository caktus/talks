<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Scaling Your Write-Heavy Django App: A Case Study</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Scaling Your Write-Heavy Django App: A Case Study</h1></header>
            
            
            <section><p>Tobias McNulty</p>
<p><a class="reference external" href="https://twitter.com/tobiasmcnulty">&#64;tobiasmcnulty</a></p>
<p>Slides: <a class="reference external" href="http://cakt.us/djangocon-scaling">http://cakt.us/djangocon-scaling</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              1/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Talk Outline</h1></header>
            
            
            <section><ul class="simple">
<li>Introductions</li>
<li>Removing extra queries with django-debug-toolbar</li>
<li>Creating a test script with JMeter</li>
<li>Analyzing your Postgres logs for repetitive queries</li>
<li>Set up caching</li>
<li>Configuring multiple databases</li>
<li>Static media</li>
<li>Automated deployment</li>
<li>Running your test script at scale</li>
<li>Optimizing your web server configuration</li>
<li>Final tweaks to your Postgres configuration</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              2/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>About Me</h1></header>
            
            
            <section><ul class="simple">
<li>I help run Caktus</li>
<li>We build custom Python/Django web apps in NC</li>
<li>Developer with a penchant for infrastructure</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>I'm a co-founder and managing member at Caktus Group in Chapel Hill NC</li>
<li>I'm a developer, but might be a sysadmin at heart.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              3/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>5Essentials Schools Surveys</h1></header>
            
            
            <section><p>Started at UChicago; 5Essentials team designs and conducts surveys to assess:</p>
<ul class="simple">
<li>Effective leaders</li>
<li>Collaborative teachers</li>
<li>Involved families</li>
<li>Supportive environment</li>
<li>Ambitious instruction</li>
</ul>
<p>Schools with strong scores on at least 3 of these are 10 times more likely to improve math and reading.</p>
<p>See: <a class="reference external" href="http://uchicagoimpact.org/5essentials/">http://uchicagoimpact.org/5essentials/</a></p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>I'll be talking about a client project we've been working on at Caktus for the past 2 years</li>
<li>5 essentials survey admin module</li>
<li>This group, here in Chicago, has been conducting surveys for years geared towards improving educational outcomes</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              4/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>From Scantron...</h1></header>
            
            
            <section><img alt="static/scantron.jpg" class="align-center" src="static/scantron.jpg" />
<p>Image: <a class="reference external" href="http://www.flickr.com/photos/thedavisblog/2230010178">http://www.flickr.com/photos/thedavisblog/2230010178</a></p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Traditionally this was done via Scantron</li>
<li>But, in 2011, Caktus was approached by the 5E / UChicago team to help build a highly scalable web application in Django</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              5/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>About the Project</h1></header>
            
            
            <section><p><strong>5Essentials Survey Admin Module (SAM)</strong></p>
<ul class="simple">
<li>2011: Caktus hired by UChicago / 5Essentials</li>
<li>2012: First survey for Chicago Public Schools (~400,000 students)</li>
<li>2013: First Illinois state-wide survey (2 million students, teachers, and parents)</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The first survey was administered with the system in early 2012, for Chicago Public Schools</li>
<li>CPS is 3rd largest in US, over 400,000 students</li>
<li>5E has a number of clients outside Chicago</li>
<li>As of 2013 this inclues the Illinois State Board of Education</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              6/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>...to Scalable Web App</h1></header>
            
            
            <section><img alt="static/survey.jpg" class="align-center" src="static/survey.jpg" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Earlier this year they conducted the first state-wide survey using this tool, for over 2 million parents, students, and teachers</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              7/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fast or Scalable?</h1></header>
            
            
            <section><ul class="simple">
<li>Fast: the code runs quickly</li>
<li>Scalable: runs acceptably (or better) for lots of people</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Just a quick reminder, this talk is not about making your code fast, it's about making infrastructure that can scale</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              8/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Why this talk?</h1></header>
            
            
            <section><p>Scaling read-heavy web apps is easy:</p>
<ul class="simple">
<li>Add caching, add web servers</li>
<li>Rinse, repeat</li>
</ul>
<p>Taking a survey means saving lots of data really fast.</p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Furthermore, this talk is unique because it's about doing lots of database writes, which is usually a harder problem to solve</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              9/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Architecture</h1></header>
            
            
            <section><ul class="simple">
<li>Python 2.7</li>
<li>Django 1.5</li>
<li>PostgreSQL 9.1</li>
<li>Nginx</li>
<li>Gunicorn</li>
<li>S3 for static media</li>
<li>Celery</li>
<li>RabbitMQ</li>
<li>Redis</li>
<li>Memcached</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before we dive in, here's a quick overview of what we have to work with tools-wise</li>
<li>The usual suspects, Python 2.7, Django 1.5, and Postgres 9.1</li>
<li>For web server we're using Nginx to proxy a set of Gunicorn workers, and S3 for static media</li>
<li>We're using Celery and rabbitMQ for background tasks</li>
<li>Redis for sessions</li>
<li>And memcached for a cache</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              10/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 1: django-debug-toolbar</h1></header>
            
            
            <section><p>Install it:</p>
<pre>pip install django-debug-toolbar
</pre>
<p>And add it to your local development settings file:</p>
<pre><span class="n">INTERNAL_IPS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,)</span>
<span class="n">MIDDLEWARE_CLASSES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;debug_toolbar.middleware.DebugToolbarMiddleware&#39;</span><span class="p">)</span>
<span class="n">INSTALLED_APPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;debug_toolbar&#39;</span><span class="p">)</span>
</pre>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The first step in any scaling project should generally be to make sure you're not doing anything too crazy code- or DB-wise</li>
<li>If you haven't used it, you really need get django-debug-toolbar now</li>
<li>It's really easy to install and use</li>
<li>Helps eliminate unnecessary SQL queries on high-traffic pages</li>
<li>Don't blindly optimize everything, focus on pages that'll give you the most gain</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              11/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 1: django-debug-toolbar</h1></header>
            
            
            <section><p>Common patterns include:</p>
<ul class="simple">
<li><strong>select_related:</strong> When iterating through a list of model objects, use <tt class="docutils literal">select_related()</tt> with specific field names to retrieve everything you need in one query. Make sure the combined query isn't more expensive.</li>
<li><strong>request-local caching:</strong> Find identical queries that you make multiple times during the same request, and cache their output on the request or other relevant Python object (not via <tt class="docutils literal">django.core.cache</tt>)</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Remember, we want to limit the total amount of stuff that the DB server has to do</li>
<li>Ultimately we only care about writes, but if the database server is doing lots of unnecessary reads, that'll slow it down</li>
<li>Some but not all of this can be taken care of with a DB slave</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              12/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 2: Automate some load</h1></header>
            
            
            <section><p>Before going any further, you need an easy way to generate load. JMeter's a good tool for that; here there are a few tips:</p>
<ul class="simple">
<li><strong>Recording:</strong> If you have a long or complicated process to test, use JMeter's proxy server to record your actions in a web browser</li>
<li><strong>Sane defaults:</strong> Set up sane defaults using HTTP Request Defaults, so you can easily switch servers.</li>
<li><strong>CSRF Token:</strong> Use JMeter's HTTP Cookie Manager to save and retrieve the token</li>
<li><strong>Test script:</strong> Save your test script along side your other infrastructure files in version control.</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>need a way to generate some load automatically, don't want to rely on manually clicking around the site, will be doing this in jmeter</li>
<li>Simple tasks are easy enough to script manually, but it's a lot easier to script longer tasks (like filling out an entire survey) by recording.  JMeter has great tools for this; learn to use &amp; love them.</li>
<li>You'll want to test different server environments (including your local machine), so practice DRY test script writing and take the time to setup good default for HTTP requests.</li>
<li>The CSRF token can be a bit hair to keep track of at first, but once you have it set up it's easy to maintain.</li>
<li>Save your test scripts in version control and continue to refine them.  They'll come in handy over and over again..  Really.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              13/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 3: pgfouine</h1></header>
            
            
            <section><p>Next, pgfouine can help you detect high-frequency, redundant queries <em>across</em> multiple requests.</p>
<p>On Debian or Ubuntu:</p>
<pre>apt-get install pgfouine
</pre>
<p>Edit <tt class="docutils literal">postgresql.conf</tt>:</p>
<pre><span class="n">log_min_duration_statement</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># log all statements with durations</span>
<span class="n">log_line_prefix</span> <span class="o">=</span> <span class="s">&#39;%t [%p]: [%l-1] &#39;</span> <span class="c"># pgfouine-specific log prefix</span>
<span class="n">lc_messages</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span> <span class="c"># character encoding pgfouine can understand</span>
</pre>
<p>After generating some load, run <tt class="docutils literal">pgfouine</tt> on your log file:</p>
<pre>pgfouine -file /var/log/postgresql/postgresql.log -logtype stderr &gt; report.html
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              14/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 3: pgfouine</h1></header>
            
            
            <section><img alt="static/pgfouine.png" class="align-center" src="static/pgfouine.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              15/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 4: Let's play cache</h1></header>
            
            
            <section><p>We have the data, let's cache strategically.  Options:</p>
<ul class="simple">
<li>Django's per-site or per-view caches <strong>&lt;- this talk is not about these; you should be using them (if you can) anyways</strong></li>
<li>Django's <strong>low-level cache API</strong></li>
<li><strong>johnny-cache</strong> - Great if you need to cache everything</li>
<li><strong>django-cache-machine</strong> - Great if you need to cache specific things in specific ways</li>
<li>There are many others...</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Based on all the output from pgfouine, you should have a good sense of what queries will give you the most gain for caching.</li>
<li>Find select statements that you don't expect to change often (if at all), and cache them</li>
<li>Find a strategy that works for you; we tried to make johnny-cache work, but it was too much black magic for us</li>
<li>We found django-cache-machine worked better; it allowed us to cache exactly what we want when we wanted in predictable ways</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              16/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>django-cache-machine</h1></header>
            
            
            <section><p>Install it:</p>
<pre><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">machine</span>
</pre>
<p>Activate it:</p>
<pre><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">caching</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">CachingManager</span><span class="p">()</span>
</pre>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>You can overwride the default manager or create a new one</li>
<li>We chose the latter to make it explicit that you were caching</li>
<li>This worked better for us, b/c there's nothing worse that debugging stale cache issues</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              17/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>django-cache-machine</h1></header>
            
            
            <section><p>Some things to be aware of:</p>
<ul class="simple">
<li>django-cache-machine does not cache empty querysets by default.  If you have a lot these, you might want to turn this on:</li>
</ul>
<pre><span class="c"># settings.py</span>
<span class="n">CACHE_EMPTY_QUERYSETS</span> <span class="o">=</span> <span class="bp">True</span>
</pre>
<ul class="simple">
<li><tt class="docutils literal">count()</tt> cannot easily be invalidated, so these queries time out instead.  Set the timeout to something that makes sense for you:</li>
</ul>
<pre><span class="c"># settings.py</span>
<span class="n">CACHE_COUNT_TIMEOUT</span> <span class="o">=</span> <span class="mi">300</span>
</pre>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Once you have caching setup, <strong>use pgfouine to verify that it did what you expected</strong></li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              18/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>pgfouine, before</h1></header>
            
            
            <section><img alt="static/pgfouine-before.png" class="align-center" src="static/pgfouine-before.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              19/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>pgfouine, after</h1></header>
            
            
            <section><img alt="static/pgfouine-after.png" class="align-center" src="static/pgfouine-after.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>As you can see, a little caching quickly cut the SELECT statements by 25,000, to less than 10% of its former value</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              20/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 5: Multiple databases</h1></header>
            
            
            <section><ul class="simple">
<li><strong>Replication:</strong> Streaming replication in PostgreSQL 9.1</li>
<li><strong>Database routing:</strong> django-balancer</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Streaming replication in PostgreSQL 9.1 is incredibly easy to set up. You should learn to use and love it.</li>
<li>To get multiple databases working in Django you need to use a custom database router.  A good source we've found for this is django-balancer</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              21/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>django-balancer</h1></header>
            
            
            <section><p>Install it:</p>
<pre>pip install django-balancer
</pre>
<p>Configure it:</p>
<pre><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;balancer.routers.PinningWMSRouter&#39;</span><span class="p">]</span>
<span class="n">MIDDLEWARE_CLASSES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;balancer.middleware.PinningCookieMiddleware&#39;</span><span class="p">)</span>
<span class="n">DATABASE_POOL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;db-slave&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">MASTER_DATABASE</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
<span class="n">MASTER_PINNING_KEY</span> <span class="o">=</span> <span class="s">&#39;master_db_pinned&#39;</span>
<span class="n">MASTER_PINNING_SECONDS</span> <span class="o">=</span> <span class="mi">5</span>
</pre>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>This is a good setup for a master/slave databases</li>
<li>It sends writes to the master and reads to the slaves, unless a session has written to master in which case reads will also be pinned to the master for 5 seconds.  This avoids data &quot;disappearing&quot; if you attempt to read it back before it propagates to the slave.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              22/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Custom database router</h1></header>
            
            
            <section><ul class="simple">
<li>In survey app, most common views always write to DB</li>
<li>Some models don't change during survey taking (those describing the survey)</li>
<li>Send all reads to slave for some (not all) models</li>
</ul>
<p>See: <a class="reference external" href="http://cakt.us/scaling-router">http://cakt.us/scaling-router</a></p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There's a problem with this</li>
<li>Some sessions (e.g., survey taking) write to the DB on every request</li>
<li>BUT some models never change</li>
<li>We wrote a simple database router based on django-balancer that makes some models &quot;read only&quot; during certain views</li>
<li>Just wrap the views you care about with the given decorator, and SELECT queries for the given models will always go to a slave</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              23/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 6: Static Media</h1></header>
            
            
            <section><p>... is simple and painless if you:</p>
<ol class="arabic simple">
<li>Use <tt class="docutils literal">django_compressor</tt>.</li>
<li>Put your media on S3 or CloudFiles.</li>
<li>Please, please, <em>please</em> enable offline compression.</li>
<li>Put a version number in your compress manifest name:</li>
</ol>
<pre><span class="n">COMPRESS_OFFLINE_MANIFEST</span> <span class="o">=</span> <span class="s">&#39;manifest-{{ current_changeset }}.json&#39;</span>
</pre>
<ol class="arabic simple" start="5">
<li>If your <tt class="docutils literal">{% compress %}</tt> template tag needs to be in an {% if  %} tag, put it in its own template and <tt class="docutils literal">{% include %}</tt> it.</li>
</ol>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Django compressor is great and pulls together a number of important extras on top of django.contrib.staticfiles.</li>
<li>It not only can compress + combine your CSS and JS, but can also do things like process your LESS or SAS files for you at deploy time.</li>
<li>You really do not want these things taking up a Python web server process, so get them out of the way when you deploy and stop worrying about static media.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              24/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Step 7: Automated Server Provisioning</h1></header>
            
            
            <section><ul class="simple">
<li>Chef, Puppet, or Salt for server configuration</li>
<li>We used FabulAWS which has declarative configuration in Python</li>
<li>Use Fabric or something similar to deploy</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Picking an automated server provisioning and deployment tool set is really important</li>
<li>There's no point trying to scale if you can't quickly and easily create, destroy, and update servers of all types (database, cache, web, worker, etc.)</li>
<li>This setup is a topic unto itself, but find something that works for you, stick to it, and perfect it.</li>
<li>If we were to do it over again, today, I'd definitely use Salt instead of rolling our own.  I prefer Python so I'm not a huge fan of Chef or Puppet.</li>
<li>This becomes particularly important when it comes time to tweak server configuration files on 10-20 web servers at once.  You DO NOT want to be doing that manually.</li>
</ul>



<h1>Quick Review</h1>
<p>So far we have:</p>
<ul class="simple">
<li>Removed excess queries with django-debug-toolbar and pgfouine</li>
<li>Implemented a basic load testing script in JMeter</li>
<li>Set up caching for repetative queries</li>
<li>Moved all our reads to a slave database</li>
<li>Automated deployment and offloaded static media</li>
</ul>

<h2>Presenter Notes</h2>
<ul class="simple">
<li>Now comes the fun part</li>
<li>We have all the ground work in place</li>
<li>We're not doing anything overly stupid (or so we think)</li>
<li>Let's try load testing at scale</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              25/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Why load test?</h1></header>
            
            
            <section><ul class="simple">
<li>Obtain estimates of per-web server capacity</li>
<li>Correctly size your database servers</li>
<li>Fix any configuration bottlenecks</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There are lots of good reasons to load test, most of which fall along the same lines of why we do any testing</li>
<li>We want to discover problems and fix them before our users see them</li>
<li>In this case, we're really testing the infrastructure itself</li>
<li>Did we configure all the different services correctly?</li>
<li>Can my servers handle the load?</li>
<li>Problems of scale are particulary easy to ignore, because you really don't see them during development unless you try really hard</li>
<li>Conversely, load testing lets you avoid premature optimization by backing up configuration choices with real data rather than abstract guesses</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              26/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Before we start</h1></header>
            
            
            <section><ul class="simple">
<li>Many interdependent configs</li>
<li>Don't guess, make a spreadsheet</li>
<li>Calculate how many connections you need to different services</li>
<li>Make educated forecasts about capacity</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before you take on a project like this, I highly recommend mapping out the key configuration items in a spreadsheet</li>
<li>Helps you figure out what to set all the various connection limits and worker counts to</li>
<li>Also helps forecase load capacity</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              27/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Spreadsheet</h1></header>
            
            
            <section><img alt="static/spreadsheet.png" class="align-center" src="static/spreadsheet.png" />
<p>See: <a class="reference external" href="http://cakt.us/scaling-config">http://cakt.us/scaling-config</a></p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's an example of a spreadsheet we put together for this project</li>
<li>There's a link to a google doc you can copy and tweak</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              28/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Generating load at scale</h1></header>
            
            
            <section><ul class="simple">
<li>Single JMeter instance not useful above 400-600 threads</li>
<li>Need to run load test from the cloud</li>
<li>Do it yourself, or use BlazeMeter or another provider</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>JMeter is great, but not useful above 400-600 threads on a laptop</li>
<li>I played around with a few things for this, eventually settled on a service called BlazeMeter</li>
<li>Lets you upload your JMeter scripts and deploy them to multiple EC2 servers, and collect the results</li>
<li>Integrates with New Relic</li>
<li>(Neither of these companies are paying me to say this, though they probably should)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              29/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>survey_change_page, gevent</h1></header>
            
            
            <section><img alt="static/nr1/sample1.png" class="align-center" src="static/nr1/sample1.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's one of the first graphs we saved while load testing</li>
<li>From the main view for survey taking that does the writes to disk</li>
<li>The big bars are redis GET and SET</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              30/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>What's going on?</h1></header>
            
            
            <section><ul class="simple">
<li>redis oddly slow, but not overloaded</li>
<li>Also saw nf_conntrack errors in dmesg</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Redis appeared to be slow in new relic, but when tested from the console, it was lightning fast (even under load).</li>
<li>We were getting lots of nf_conntrack errors in dmesg</li>
<li>This is using the gevent worker, which uses an event loop to process lots of requests in the same thread</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              31/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>survey_change_page, sync</h1></header>
            
            
            <section><img alt="static/nr2/sample2.png" class="align-center" src="static/nr2/sample2.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>We disabled connection tracking and switched to the sync worker</li>
<li>Bottleneck immediately transferred to the database INSERT statement</li>
<li>What is happening here?</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              32/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>What was happening?</h1></header>
            
            
            <section><ul class="simple">
<li>gevent worker is really bad for CPU-bound applications</li>
<li>Makes I/O <strong>look</strong> expensive</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>gevent worker is intended for long-polling applications, when you need to open lots of inactive HTTP connections</li>
<li>This can be really bad for CPU-bound applications that open and close lots of connections</li>
<li>Can make I/O look expensive, when the real problem is each thread is trying to process too many requests at once</li>
<li>The Linux kernel is really good at pre-emptive multitasking.  You should let it do its job and use the sync worker for CPU bound applications.</li>
<li>Moving on, now we have a new problem...</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              33/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>database reponse time</h1></header>
            
            
            <section><img alt="static/nr2/dashboard-crash.png" class="align-center" src="static/nr2/dashboard-crash.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>As you can see, DB response time sky rockets, and the server eventually crashes before the test is complete</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              34/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>database falls over</h1></header>
            
            
            <section><img alt="static/nr2/pg-crash.png" class="align-center" src="static/nr2/pg-crash.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's a screenshot of TOP immediately before the crash; lots of defunct postgres processes and a load average of 182.</li>
<li>Not good.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              35/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>database still overloaded</h1></header>
            
            
            <section><img alt="static/nr3/sample3.png" class="align-center" src="static/nr3/sample3.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Increased database server size by several orders of magnitude - 68 GB of ram and 26 EC2 compute units</li>
<li>DB server still slow and overloaded.. what is wrong?</li>
<li>Went back and checked the math..</li>
<li>Oops.. we're load testing 3x our target, swamping the servers with requests they can't process</li>
<li>Make yourself a spreadsheet upfront so you don't make the same mistake I did</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              36/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>the right target load</h1></header>
            
            
            <section><img alt="static/nr4/sample4.png" class="align-center" src="static/nr4/sample4.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>database server response time is nice and fast</li>
<li>redis is taking up more time than the DB again</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              37/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>requests are right where we want</h1></header>
            
            
            <section><img alt="static/nr4/dashboard-pre-final.png" class="align-center" src="static/nr4/dashboard-pre-final.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>target reqs/min are right where we want at 75,000</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              38/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>postgres transactions are through the roof</h1></header>
            
            
            <section><img alt="static/nr4/pg-transactions.png" class="align-center" src="static/nr4/pg-transactions.png" />

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>postgresql master transactions hit over 9,500 per second</li>
<li>the majority of them writes</li>
<li>wow!</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              39/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>recreate from scratch, test again</h1></header>
            
            
            <section><ul class="simple">
<li>Recreated all servers from scratch</li>
<li>Response time was no where near what it was before</li>
<li>Postgres could barely hit 6,000 transactions/second</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Just to check everything, recreated all the servers</li>
<li>Performance dropped significantly</li>
<li>Discovered a couple database server configuration changes I neglected to add to version control</li>
<li>Before getting to those, a couple notes on optimizing your pg config in general</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              40/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Optimizing your PostgreSQL config</h1></header>
            
            
            <section><ul class="simple">
<li>Postgres When It's Not Your Job (thebuild.com)</li>
<li>pgtune</li>
<li><a class="reference external" href="http://cakt.us/pg-tuning">http://cakt.us/pg-tuning</a></li>
<li><a class="reference external" href="http://cakt.us/pg-conns">http://cakt.us/pg-conns</a></li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Optimizing your Postgres config is a topic until itself</li>
<li>Our conference chair christophe gave an excellent talk last year titled Postgres When It's Not your Job.  You should get the slides and read them - it's amazing.</li>
<li>If you're looking for something quick, pgtune can be used to generate some sane defaults for a number of postgres config options</li>
<li>The last two links are to the Postgres wiki; they provide a lot of valuable discussion about different config options and how they interact</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              41/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Figuring out max_connections</h1></header>
            
            
            <section><ul class="simple">
<li>Base max_connections on database server resources, not web server count</li>
<li>Use pgbouncer to share a small number of persistent connections</li>
<li>Run pgbouncer on your web servers using <tt class="docutils literal">supervisord</tt></li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>After a point, the more your database server is doing at once, the longer it takes for <strong>every</strong> task</li>
<li>The right value for this setting is determined by machine resouces, NOT how many connections you think you need to open</li>
<li>You can use transaction-level isolation in pgbouncer to share 2-3 connections across 30 web processes with no loss of performance</li>
<li>Installing pgbouncer on your web servers can also limit the time spent opening connections</li>
<li>If you're already using supervisord, it's an easy addition to run pgbouncer to your config (rather than mucking around with files in /etc/)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              42/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>What was this talk about again?</h1></header>
            
            
            <section><p>Optimizing <tt class="docutils literal">postgresql.conf</tt> for heavy <tt class="docutils literal">INSERT</tt> load:</p>
<ul class="simple">
<li><strong>commit_delay = 4000</strong> - delay each commit this many microseconds in case we can do a group commit</li>
<li><strong>commit_siblings = 5</strong> - only delay if at least N transactions are in process</li>
</ul>
<p>(Note: this is now even better in PostgreSQL 9.2: <a class="reference external" href="http://cakt.us/pg-group-commit">http://cakt.us/pg-group-commit</a>)</p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There's rarely a magic bullet in server configuration, but this turned out to be it for us.</li>
<li>commit_delay - Rarely helps, but when it does, it helps a lot (and write-intensive applications are the perfect time to use it).</li>
<li>It works by sleeping for a set number of microseconds immediately before syncing to disk</li>
<li>When it wakes up, it checks to see if any other transactions are also sleeping before syncing</li>
<li>It &quot;takes over&quot; all sleeping transactions, syncing their data to disk at the same time as its own</li>
<li>When a transaction wakes up, it checks to see if it's already been sync'ed, and if it has, it returns immediately to the user</li>
<li>While this can make everything slower, but setting commit_siblings to a resonable value can make sure it only impacts performance when there might be something to be gained.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              43/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Another option</h1></header>
            
            
            <section><ul class="simple">
<li><strong>synchronous_commit = off</strong> - don't wait for fsync before returning success</li>
</ul>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Another useful option that can be handy if you don't care about the durability of a transaction is synchronous_commit</li>
<li>It's not as bad as disabling fsync b/c there's no risk of data inconsistency</li>
<li>But IF the server crashes BEFORE it can call fsync but AFTEr it returns success to the user, there might be an inconsistency between what the user thinks was saved and what was actually saved.</li>
<li>Obviously this is not good for banking transactions, but there are plenty of other less critical applications out there that might benefit from disabling this feature in Postgres.</li>
<li>We did not use this in the survey app because commit_delay got us where we needed to be.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              44/45
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Questions?</h1></header>
            
            
            <section><ul class="simple">
<li>Tobias McNulty</li>
<li>Twitter: <a class="reference external" href="https://twitter.com/tobiasmcnulty">&#64;tobiasmcnulty</a></li>
<li>Hire us: <a class="reference external" href="http://www.caktusgroup.com">http://www.caktusgroup.com</a></li>
<li>Slides: <a class="reference external" href="http://cakt.us/djangocon-scaling">http://cakt.us/djangocon-scaling</a></li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              45/45
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Scaling Your Write-Heavy Django App: A Case Study</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Talk Outline</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">About Me</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">5Essentials Schools Surveys</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">From Scantron...</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">About the Project</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">...to Scalable Web App</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Fast or Scalable?</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Why this talk?</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Architecture</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Step 1: django-debug-toolbar</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Step 1: django-debug-toolbar</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Step 2: Automate some load</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Step 3: pgfouine</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">Step 3: pgfouine</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Step 4: Let's play cache</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">django-cache-machine</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">django-cache-machine</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">pgfouine, before</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">pgfouine, after</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Step 5: Multiple databases</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">django-balancer</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Custom database router</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Step 6: Static Media</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Step 7: Automated Server Provisioning</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Why load test?</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Before we start</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Spreadsheet</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Generating load at scale</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">survey_change_page, gevent</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">What's going on?</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">survey_change_page, sync</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">What was happening?</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">database reponse time</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">database falls over</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">database still overloaded</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
      <tr id="toc-row-37">
        <th><a href="#slide37">the right target load</a></th>
        <td><a href="#slide37">37</a></td>
      </tr>
      
      
      <tr id="toc-row-38">
        <th><a href="#slide38">requests are right where we want</a></th>
        <td><a href="#slide38">38</a></td>
      </tr>
      
      
      <tr id="toc-row-39">
        <th><a href="#slide39">postgres transactions are through the roof</a></th>
        <td><a href="#slide39">39</a></td>
      </tr>
      
      
      <tr id="toc-row-40">
        <th><a href="#slide40">recreate from scratch, test again</a></th>
        <td><a href="#slide40">40</a></td>
      </tr>
      
      
      <tr id="toc-row-41">
        <th><a href="#slide41">Optimizing your PostgreSQL config</a></th>
        <td><a href="#slide41">41</a></td>
      </tr>
      
      
      <tr id="toc-row-42">
        <th><a href="#slide42">Figuring out max_connections</a></th>
        <td><a href="#slide42">42</a></td>
      </tr>
      
      
      <tr id="toc-row-43">
        <th><a href="#slide43">What was this talk about again?</a></th>
        <td><a href="#slide43">43</a></td>
      </tr>
      
      
      <tr id="toc-row-44">
        <th><a href="#slide44">Another option</a></th>
        <td><a href="#slide44">44</a></td>
      </tr>
      
      
      <tr id="toc-row-45">
        <th><a href="#slide45">Questions?</a></th>
        <td><a href="#slide45">45</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15492387-10']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
</body>
</html>