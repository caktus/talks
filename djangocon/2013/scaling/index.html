<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Scaling Your Write-Heavy Django App: A Case Study</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Scaling Your Write-Heavy Django App: A Case Study</h1></header>
            
            
            <section><p>Tobias McNulty</p>
<p><a class="reference external" href="https://twitter.com/tobiasmcnulty">&#64;tobiasmcnulty</a></p>
<p>Slides: <a class="reference external" href="http://cakt.us/djangocon-scaling">http://cakt.us/djangocon-scaling</a></p>

</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Hello everyone, today I'll be talking about scaling your write heavy Django app</li>
<li>A little about me before we start..</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              1/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>About Me</h2></header>
            
            
            <section><ul class="simple">
<li>I help run Caktus</li>
<li>We build custom Python/Django web apps in NC for clients everywhere</li>
<li>Developer with a penchant for infrastructure</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>I'm a co-founder and managing member at Caktus Group in Chapel Hill NC</li>
<li>We've been building Django web apps for clients since 2007</li>
<li>I'm a developer by trade, but quite possibly a sysadmin at heart.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              2/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Talk Outline</h2></header>
            
            
            <section><ul class="simple">
<li>Project Overview</li>
<li>Scaling Phase I: Chicago Public Schools</li>
<li>Scaling Phase II: The State of Illinois</li>
<li>Optimizing Your PostgreSQL Config</li>
<li>Final Tweaks</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>My talk today will be broken up into three larger sections</li>
<li>In the first I'll give you an overview of the project itself and why scale was a problem for us</li>
<li>Second, I'll cover the first round of scaling that we did for Chicago Public Schools. This will be more of a step by step guide on one approach you might take to scaling</li>
<li>Third, I'll go into details on the more iterative load testing that we did to scale the site further for the State of Illinois</li>
<li>I'll end with two short sections on some final tweaks to Postgres and other services</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              3/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Project Overview</h2></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              4/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>5Essentials Schools Surveys</h2></header>
            
            
            <section><p>Started at UChicago; 5Essentials team designs and conducts surveys to assess:</p>
<ul class="simple">
<li>Effective leaders</li>
<li>Collaborative teachers</li>
<li>Involved families</li>
<li>Supportive environment</li>
<li>Ambitious instruction</li>
</ul>
<p>Schools with strong scores on at least 3 of these are 10 times more likely to improve math and reading.</p>
<p>See: <a class="reference external" href="http://uchicagoimpact.org/5essentials/">http://uchicagoimpact.org/5essentials/</a></p>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The project I'll be talking about is a client project we've been working on at Caktus for the past 2 years</li>
<li>5 essentials survey admin module</li>
<li>This group, here in Chicago, has been conducting surveys for years geared towards improving educational outcomes</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              5/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>From Scantron...</h2></header>
            
            
            <section><img alt="static/scantron.jpg" class="align-center" src="static/scantron.jpg" />
<p>Image: <a class="reference external" href="http://www.flickr.com/photos/thedavisblog/2230010178">http://www.flickr.com/photos/thedavisblog/2230010178</a></p>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Traditionally this was done via Scantron</li>
<li>But, in 2011, Caktus was approached by the 5E / UChicago team to help build a highly scalable web application in Django</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              6/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>About the Project</h2></header>
            
            
            <section><p><strong>5Essentials Survey Admin Module (SAM)</strong></p>
<ul class="simple">
<li>2011: Caktus hired by UChicago / 5Essentials</li>
<li>2012: First survey for Chicago Public Schools (~400,000 students)</li>
<li>2013: First Illinois state-wide survey (2 million students, teachers, and parents)</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The first survey was administered with the system in early 2012, for Chicago Public Schools</li>
<li>CPS is 3rd largest in US, over 400,000 students</li>
<li>5E also has a number of clients outside Chicago</li>
<li>As of 2013, this includes the Illinois State Board of Education</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              7/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>...to Scalable Web App</h2></header>
            
            
            <section><img alt="static/survey.jpg" class="align-center" src="static/survey.jpg" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>And, earlier this year, they conducted the first state-wide survey using this tool, for over 2 million parents, students, and teachers</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              8/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Survey Composition</h2></header>
            
            
            <section><ul class="simple">
<li>Up to 50-60 pages per survey</li>
<li>Around 4-6 questions per page</li>
<li>Respondents complete in an hour or less</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before we start talking about scaling it's helpful to have a sense of what a typical survey might look like</li>
<li>The surveys are typically broken up into quite a few pages with several questions on each page</li>
<li>Each student is allotted an hour to take it (they don't usually take the full amount of time)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              9/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Write-heavy App</h2></header>
            
            
            <section><ul>
<li><p class="first">Many auxiliary views (about 80)</p>
</li>
<li><dl class="first docutils">
<dt>Roughly 5 high-use views for survey taking:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal">survey_login</tt> - Login page</li>
<li><tt class="docutils literal">survey_display</tt> - Load main page for survey taking</li>
<li><tt class="docutils literal">survey_change_page</tt> - Ajax <tt class="docutils literal">POST</tt> URL (for saving current data)</li>
<li><tt class="docutils literal">survey_content</tt> - Ajax <tt class="docutils literal">GET</tt> URL (for next page)</li>
<li><tt class="docutils literal">survey_complete</tt> - Non-ajax <tt class="docutils literal">GET</tt> upon survey completion</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first"><tt class="docutils literal">Model.objects.bulk_create()</tt> helps</p>
</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The project is quite large, with about 85 Django views in total and at least 40 custom models</li>
<li>Only about 5 of those views really matter scaling-wise</li>
<li>The remaining 80 or so are for use by administrators uploading surveys or rosters, downloading responses, managing users, and other related tasks</li>
<li>A core requirement was to save the results to disk on each page submission--this was so we didn't lose any data we'd reported to have saved</li>
<li>This means 4-5 INSERT statements per page, which can be grouped into one statement using the bulk_create method in Django 1.4, but this does not eliminate the scaling problem of doing that many writes</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              10/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Fast or Scalable?</h2></header>
            
            
            <section><ul class="simple">
<li>Fast: the code runs quickly</li>
<li>Scalable: runs acceptably (or better) for lots of people</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>This brings up the good point that this talk is not about making your code fast, it's about making infrastructure that can scale</li>
<li>We really don't care about those other 80 views for scaling purposes</li>
<li>The main problem we're likely to run into is inserting all that data into the response items table</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              11/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Architecture</h2></header>
            
            
            <section><ul class="simple">
<li>Python 2.7</li>
<li>Django 1.5</li>
<li>PostgreSQL 9.1</li>
<li>Nginx</li>
<li>Gunicorn</li>
<li>S3 for static media</li>
<li>Celery</li>
<li>RabbitMQ</li>
<li>Redis</li>
<li>Memcached</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before we dive in, here's a quick overview of what we have to work with tools-wise</li>
<li>The usual suspects, Python 2.7, Django 1.5, and Postgres 9.1</li>
<li>For web server we're using Nginx to proxy a set of Gunicorn workers, and S3 for static media</li>
<li>We're using Celery and rabbitMQ for background tasks</li>
<li>Redis for sessions and cache initially</li>
<li>And ultimately we switched to memcached for the cache and left sessions in redis</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              12/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Systems Diagram</h2></header>
            
            
            <section><img alt="static/CCSR_server_diagram.png" class="align-center" src="static/CCSR_server_diagram.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>I'll show this slide again later, but here's a rough outline of what the server infrastructure looked like</li>
<li>Services are all split out onto separate servers, with the exception of the cache server which runs rabbitmq, redis, and memcached</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              13/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Scaling Phase I: Chicago Public Schools</h2></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              14/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Phase I Scaling Target</h2></header>
            
            
            <section><ul class="simple">
<li>About 210,000 students (400,000 eligible)</li>
<li>About 24,000 teachers</li>
<li>Up to 8,000 survey takers per hour</li>
<li>Around 275 requests/second</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The first phase of scaling was relatively straight forward; a single laptop could simulate enough load to mimick the maximum expected requests per second.</li>
<li>We completed this first round of scaling at the end of 2011, before the start of the first web-based Chicago Public Schools survey</li>
<li>The following steps roughly outline the approach we took in hitting this target</li>
<li>The number of reqs/sec is not particularly high, but remember that these are all dynamic requests, about half of which will be writing to disk</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              15/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 1: django-debug-toolbar</h2></header>
            
            
            <section><p>Install it:</p>
<pre>pip install django-debug-toolbar
</pre>
<p>And add it to your local development settings file:</p>
<pre><span class="n">INTERNAL_IPS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,)</span>
<span class="n">MIDDLEWARE_CLASSES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;debug_toolbar.middleware.DebugToolbarMiddleware&#39;</span><span class="p">)</span>
<span class="n">INSTALLED_APPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;debug_toolbar&#39;</span><span class="p">)</span>
</pre>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>The first step in any scaling project should generally be to make sure you're not doing anything too crazy code- or DB-wise</li>
<li>Hopefully all of you are already using django-debug-toolbar already, but just in case, I threw in this slide</li>
<li>Easy to install; helps eliminate unnecessary SQL queries on high-traffic pages</li>
<li>Don't blindly optimize everything, focus on pages that'll give you the most gain; in this case we focused on those 5 survey taking views</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              16/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 1: Common query reduction patterns</h2></header>
            
            
            <section><p>Common patterns include:</p>
<ul class="simple">
<li><strong>select_related:</strong> When iterating through a list of model objects, use <tt class="docutils literal">select_related()</tt> with specific field names to retrieve everything you need in one query. Make sure the combined query isn't more expensive.</li>
<li><strong>request-local caching:</strong> Find identical queries that you make multiple times during the same request, and cache their output on the request or other relevant Python object (not via <tt class="docutils literal">django.core.cache</tt>)</li>
<li><strong>write-through cache:</strong> Find rows that you write (e.g., in a <tt class="docutils literal">POST</tt> view) and then read back (e.g., in the subsequent <tt class="docutils literal">GET</tt> view) and cache them in your model's <tt class="docutils literal">save()</tt> method (see <a class="reference external" href="http://cakt.us/scaling-write-cache">http://cakt.us/scaling-write-cache</a>)</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There are a few common patterns, which I've listed out here, that you might look for when using Django-debug-toolbar</li>
<li>One less commonly optimized pattern is the write-through cache, which updates the cache at the same time as it updates the database, thereby eliminating the need to ever read back that data</li>
<li>Remember, while ultimately we only care about writes, if the database server is doing lots of unnecessary reads, that'll slow it down</li>
<li>So, we just want to limit the total amount of stuff that the DB server has to do</li>
<li>Some but not all of the reads can be taken care of with caching or a DB slave</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              17/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 2: Automate some load</h2></header>
            
            
            <section><p>You need an easy way to generate load. JMeter's a good tool for that; here there are a few tips:</p>
<ul class="simple">
<li><strong>Recording:</strong> If you have a long or complicated process to test, use JMeter's proxy server to record your actions in a web browser</li>
<li><strong>Sane defaults:</strong> Set up sane defaults using HTTP Request Defaults, so you can easily switch servers.</li>
<li><strong>CSRF Token:</strong> Use JMeter's HTTP Cookie Manager to save and retrieve the token</li>
<li><strong>Test script:</strong> Save your test script along side your other infrastructure files in version control.</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before going any further, you need a way to generate some load automatically, don't want to rely on manually clicking around the site, we found Jmeter worked pretty well for our purposes</li>
<li>Simple tasks are easy enough to script manually, but it's a lot easier to script longer tasks (like filling out an entire survey) by recording.  JMeter includes a proxy server which lets you do this from a browser.</li>
<li>You'll want to test different server environments (including your local machine), so practice good programming techniques and take the time to setup good defaults for HTTP requests.</li>
<li>The CSRF token can be a bit hairy to keep track of at first, but once you have it set up it's easy to maintain.</li>
<li>Save your test scripts in version control and continue to refine them.  They'll come in handy over and over again..</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              18/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 3: pgfouine</h2></header>
            
            
            <section><p>On Debian or Ubuntu:</p>
<pre>apt-get install pgfouine
</pre>
<p>Edit <tt class="docutils literal">postgresql.conf</tt>:</p>
<pre><span class="n">log_min_duration_statement</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># log all statements with durations</span>
<span class="n">log_line_prefix</span> <span class="o">=</span> <span class="s">&#39;%t [%p]: [%l-1] &#39;</span> <span class="c"># pgfouine-specific log prefix</span>
<span class="n">lc_messages</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span> <span class="c"># character encoding pgfouine can understand</span>
</pre>
<p>After generating some load, run <tt class="docutils literal">pgfouine</tt> on your log file:</p>
<pre>pgfouine -file /var/log/postgresql/postgresql.log -logtype stderr &gt; report.html
</pre>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Next, once you have a way to generate some load, pgfouine can help you detect high-frequency, redundant queries <em>across</em> multiple requests.</li>
<li>These could be for the same view or different views</li>
<li>pgfouine comes prepackaged on Debian and Ubuntu, and requires only a few postgres config changes to get the logs in a machine-readable format.</li>
<li>The final command generates a pretty HTML report that looks something like this:</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              19/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 3: pgfouine</h2></header>
            
            
            <section><img alt="static/pgfouine.png" class="align-center" src="static/pgfouine.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>At the top is some summary information about the number and length of queries run, including a breakdown of queries by type.</li>
<li>At the bottom, in a sortable list, are all the queries, aggregated by what pgfouine sees as similar, which just means the same queries with potentially different arguments</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              20/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 4: Let's play cache</h2></header>
            
            
            <section><p>We have the data, let's cache strategically.  Options:</p>
<ul class="simple">
<li>Django's per-site or per-view caches <strong>&lt;- this talk is not about these; you should be using them (if you can) anyways</strong></li>
<li>Django's <strong>low-level cache API</strong></li>
<li><strong>johnny-cache</strong> - Great if you need to cache everything</li>
<li><strong>django-cache-machine</strong> - Great if you need to cache specific things in specific ways</li>
<li><strong>django-better-cache</strong> - Replacement {% cache %} template tag</li>
<li>There are many others...</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Based on all the output from pgfouine, you should have a good sense of what queries will give you the most gain for caching.</li>
<li>Find select statements that you don't expect to change often (if at all), and cache them</li>
<li>There are a number of different tools you can use to do this</li>
<li>Find a strategy that works for you; we tried to make johnny-cache work, but it was too much black magic for us</li>
<li>We found django-cache-machine worked better; it allowed us to cache exactly what we wanted in more predictable ways</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              21/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 4: django-cache-machine</h2></header>
            
            
            <section><p>Install it:</p>
<pre><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">machine</span>
</pre>
<p>Activate it:</p>
<pre><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">caching</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">CachingManager</span><span class="p">()</span>
</pre>
<p>Use it:</p>
<pre><span class="n">MyModel</span><span class="o">.</span><span class="n">cached</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>When using django-cache-machine, you can overwride the default manager or create a new one</li>
<li>We chose the latter to make it explicit that you were caching</li>
<li>This worked better for us, b/c there's nothing worse that debugging stale cache issues</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              22/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 4: django-cache-machine</h2></header>
            
            
            <section><p>Some things to be aware of:</p>
<ul class="simple">
<li>Caching empty querysets:</li>
</ul>
<pre><span class="c"># settings.py</span>
<span class="n">CACHE_EMPTY_QUERYSETS</span> <span class="o">=</span> <span class="bp">True</span>
</pre>
<ul class="simple">
<li>Set timeout for <tt class="docutils literal">count()</tt> queries:</li>
</ul>
<pre><span class="c"># settings.py</span>
<span class="n">CACHE_COUNT_TIMEOUT</span> <span class="o">=</span> <span class="mi">300</span>
</pre>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Just a few things to be aware of with django-cache-machine</li>
<li>django-cache-machine does not cache empty querysets by default.  If you have a lot these, you might want to turn this on.</li>
<li><tt class="docutils literal">count()</tt> cannot easily be invalidated, so these queries time out instead.  Set the timeout to something that makes sense for you</li>
<li>Once you have caching setup the way you like, <strong>use pgfouine to verify that it did what you expected</strong></li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              23/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 4: pgfouine, before</h2></header>
            
            
            <section><img alt="static/pgfouine-before.png" class="align-center" src="static/pgfouine-before.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's the output from pgfouine before we enabled caching</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              24/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 4: pgfouine, after</h2></header>
            
            
            <section><img alt="static/pgfouine-after.png" class="align-center" src="static/pgfouine-after.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>And here's the output after</li>
<li>As you can see, a little caching quickly cut the number of SELECT statements by 25,000, to less than 10% of its former value</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              25/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 5: Multiple databases</h2></header>
            
            
            <section><ul class="simple">
<li><strong>Replication:</strong> Streaming replication in PostgreSQL 9.1</li>
<li><strong>Database routing:</strong> django-balancer</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Also somewhat help when write-scaling is to have a read slave where you can send all the non-cachable reads, to avoid swamping the master database</li>
<li>Streaming replication in PostgreSQL 9.1 is incredibly easy to set up, and that's what we used</li>
<li>To get multiple databases working in Django you need to use a custom database router.  A good source we've found for this is django-balancer</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              26/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 5: django-balancer</h2></header>
            
            
            <section><p>Install it:</p>
<pre>pip install django-balancer
</pre>
<p>Configure it:</p>
<pre><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;balancer.routers.PinningWMSRouter&#39;</span><span class="p">]</span>
<span class="n">MIDDLEWARE_CLASSES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;balancer.middleware.PinningCookieMiddleware&#39;</span><span class="p">)</span>
<span class="n">DATABASE_POOL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;db-slave&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">MASTER_DATABASE</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
<span class="n">MASTER_PINNING_KEY</span> <span class="o">=</span> <span class="s">&#39;master_db_pinned&#39;</span>
<span class="n">MASTER_PINNING_SECONDS</span> <span class="o">=</span> <span class="mi">5</span>
</pre>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>This is a good configuration for a master/slave database setup with django-balancer</li>
<li>It sends writes to the master and reads to the slaves, unless a session has written to master in which case reads will also be pinned to the master for 5 seconds.  This avoids data &quot;disappearing&quot; if you attempt to read it back before it propagates to the slave.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              27/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 5: Custom database router</h2></header>
            
            
            <section><ul class="simple">
<li>In survey app, most common views always write to DB</li>
<li>Some models don't change during survey taking (those describing the survey)</li>
<li>Send all reads to slave for some (not all) models:</li>
</ul>
<pre><span class="nd">@uses_forced_read_router</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre>
<p>See: <a class="reference external" href="http://cakt.us/scaling-router">http://cakt.us/scaling-router</a></p>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There's a problem with this</li>
<li>Some sessions (e.g., survey taking) write to the DB on every request</li>
<li>BUT some models never change</li>
<li>We wrote a simple database router based on django-balancer that makes some models &quot;read only&quot; during certain views</li>
<li>Just wrap the views you care about with the given decorator, and SELECT queries for the given models will always go to a slave</li>
<li>In a perfect world this would not get used because everything would be cached, but can help immensely during cache warming or if the cache crashes altogether</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              28/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 6: Static Media</h2></header>
            
            
            <section><p>... is simple and painless if you:</p>
<ol class="arabic simple">
<li>Use <tt class="docutils literal">django_compressor</tt>.</li>
<li>Put your media on S3 or CloudFiles.</li>
<li>Please, please, <em>please</em> enable offline compression.</li>
<li>Put a version number in your compress manifest name:</li>
</ol>
<pre><span class="n">COMPRESS_OFFLINE_MANIFEST</span> <span class="o">=</span> <span class="s">&#39;manifest-{{ current_changeset }}.json&#39;</span>
</pre>
<ol class="arabic simple" start="5">
<li>If your <tt class="docutils literal">{% compress %}</tt> template tag needs to be in an {% if  %} tag, put it in its own template and <tt class="docutils literal">{% include %}</tt> it.</li>
</ol>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Static media is not typically a scaling problem, but it can get in the way if you're not careful. It's easiest to push it off to S3 or cloud files so you can forget about it.</li>
<li>Django compressor can also help optimize your static media and pulls together a number of important extras on top of django.contrib.staticfiles.</li>
<li>It not only can compress + combine your CSS and JS, but can also do things like process your LESS or SAS files for you at deploy time.</li>
<li>You really do not want these things taking up a Python web server process, so get them out of the way when you deploy and stop worrying about static media.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              29/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Step 7: Automated Server Provisioning</h2></header>
            
            
            <section><ul class="simple">
<li>Chef, Puppet, or Salt for server configuration</li>
<li>We used FabulAWS which has declarative configuration in Python</li>
<li>Use Fabric or something similar to deploy</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Last but not least, picking an automated server provisioning and deployment tool set is really important</li>
<li>There's no point trying to scale if you can't easily create, destroy, and update servers of all types (database, cache, web, worker, etc.)</li>
<li>Choosing and using a tool is a topic unto itself, but find something that works for you, stick to it, and perfect it.</li>
<li>If we were to do it over again, today, I'd probably use Salt instead of rolling our own.  I prefer Python so I'm not a huge fan of Chef or Puppet, but I know a lot of folks in the Django community use those.</li>
<li>Having something in place becomes particularly important when it comes time to tweak server configuration files on 10-20 web servers at once.  You DO NOT want to be doing that manually.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              30/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Review of Phase I</h2></header>
            
            
            <section><p>So far we have:</p>
<ul class="simple">
<li>Removed excess queries with django-debug-toolbar and pgfouine</li>
<li>Set up caching for repetative queries</li>
<li>Moved all our reads to a slave database</li>
<li>Automated deployment and offloaded static media</li>
<li>Implemented a basic load testing script in JMeter</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>So, just a quick re-cap on Phase I</li>
<li>We have all the ground work in place</li>
<li>We're not doing anything overly stupid (or so we think)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              31/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Review of Phase I</h2></header>
            
            
            <section><ul class="simple">
<li>Tested with JMeter</li>
<li>Achieved 275 requests/second</li>
<li>10 web servers at 50-60% CPU usage each</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Using the JMeter test script we'd created, we simulated enough load to match our scaling target</li>
<li>Using an iterative trial and error process, we eliminated all the necessary bottlenecks in the survey taking views</li>
<li>After making these changes we easily hit our target of 275 requests/second, and it was evident that there was room to grow if needed</li>
<li>For this load we had about 10 high-CPU, medium EC2 instances running as web servers</li>
<li>We also found that a good load average is about 50-60% of all cores on a web server, which you can use to tune the number of servers in use</li>
<li>Anything above that and performance starts to degrade</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              32/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Scaling Phase II: The State of Illinois</h2></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>This part of the talk will be a little bit different</li>
<li>We'll focus specifically on the load testing we did for the state of illinois scaling</li>
<li>We used a similar process of iterative load testing during the first phase, but for the sake of brevity I'll only cover the specifics of what we did for phase II</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              33/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Phase II Scaling Target</h2></header>
            
            
            <section><ul class="simple">
<li>About 2 million students, teachers, and parents</li>
<li>Shorter survey</li>
<li>Up to 50,000 survey takers per hour</li>
<li>Around 75,000 requests/minute, or 1,250 request/second</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Phase II is quite a bit bigger</li>
<li>Roughly an order of magnitude in terms of numbers of users</li>
<li>Due to the shorter survey, about 5 times as many requests per second</li>
<li>Given that we're moving well beyond the load a single laptop can simulate, we will need to rethink how and why we're load testing.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              34/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Interlude: Postgres-XC</h2></header>
            
            
            <section><ul class="simple">
<li>Main pro: Write-scalable Postgres cluster</li>
<li>Main con: Dramatically increased systems complexity</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>At this point, we evaluated a number of different options, including a product called Postgres-XC</li>
<li>For all the processing that comes <em>after</em> a survey has been run, the application relies heavily on the Django ORM, so we weren't ready to sacrifice that for a new API</li>
<li>For that reason, Postgres-XC looked promising, but it was not clear if the set up could be sufficiently automated. This led us to do further load testing before committing to something like this, which brings up the good question of why load test in the first place</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              35/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Why load test?</h2></header>
            
            
            <section><ul class="simple">
<li>Obtain estimates of per-web server capacity</li>
<li>Correctly size your database servers</li>
<li>Fix any configuration bottlenecks</li>
<li>Verify the need for larger architecture changes</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>There are lots of good reasons to do this, most of which fall along the same lines of why we do any testing</li>
<li>We want to discover problems and fix them before our users see them</li>
<li>In this case, we're really testing the infrastructure itself, answering questions like: Did we configure all the different services correctly? Can my current system architecture handle the load?</li>
<li>Problems of scale are particulary easy to ignore, because you really don't see them during development unless you try really hard</li>
<li>Load testing also lets you avoid premature optimization by backing up configuration choices with real data rather than abstract guesses</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              36/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Before we start</h2></header>
            
            
            <section><ul class="simple">
<li>Many interdependent configs</li>
<li>Don't guess, make a spreadsheet</li>
<li>Calculate how many connections you need to different services</li>
<li>Make educated forecasts about capacity</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before you take on a project like this, I highly recommend mapping out the different configuration items in a spreadsheet</li>
<li>Helps you figure out what to set all the various connection limits and worker counts to</li>
<li>Also helps forecase load capacity</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              37/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Server Diagram</h2></header>
            
            
            <section><img alt="static/CCSR_server_diagram.png" class="align-center" src="static/CCSR_server_diagram.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>As a reminder, here's the server diagram for our systems architecture</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              38/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Spreadsheet</h2></header>
            
            
            <section><img alt="static/spreadsheet.png" class="align-center" src="static/spreadsheet.png" />
<p>See: <a class="reference external" href="http://cakt.us/scaling-config">http://cakt.us/scaling-config</a></p>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>This is a sample of a spreadsheet we put together for this project</li>
<li>These calculations are all about juggling what you're going to run out of</li>
<li>For example, 10 web servers, 30 workers on each, that means up to 300 open DB connections</li>
<li>That's too many, so we use pgbouncer on each of the web servers to share 2 or 3 persistent postgres connections across 30 workers</li>
<li>There's a link to a google doc you can copy and tweak</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              39/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Generating load at scale</h2></header>
            
            
            <section><ul class="simple">
<li>Single JMeter instance not useful above 400-600 threads</li>
<li>Need to run load test from the cloud</li>
<li>Do it yourself, or use BlazeMeter or another provider</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>JMeter is great, but not useful above 400-600 threads on a laptop</li>
<li>I played around with a few things for this, eventually settled on a service called BlazeMeter</li>
<li>Lets you upload your JMeter scripts and deploy them to multiple EC2 servers, and collect the results</li>
<li>Integrates with New Relic, which we'll be using to measure changes made</li>
<li>(Neither of these companies are paying me to say this, though they probably should)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              40/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>survey_change_page, gevent</h2></header>
            
            
            <section><img alt="static/nr1/sample1.png" class="align-center" src="static/nr1/sample1.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's one of the first graphs we saved while load testing, from the main view for survey taking that does the writes to disk</li>
<li>The big bars are redis GET and SET, which we found somewhat confusing</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              41/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>What's going on?</h2></header>
            
            
            <section><ul class="simple">
<li>redis oddly slow, but not overloaded</li>
<li>Also saw nf_conntrack errors in dmesg</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Redis appeared to be slow in new relic, but when tested from the console, it was lightning fast (even under load).</li>
<li>We were getting lots of nf_conntrack errors in dmesg</li>
<li>This is using the gevent worker in gunicorn, which uses an event loop to process lots of requests in the same thread</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              42/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>survey_change_page, sync</h2></header>
            
            
            <section><img alt="static/nr2/sample2.png" class="align-center" src="static/nr2/sample2.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>We disabled connection tracking in the firewall and switched to the sync worker</li>
<li>Bottleneck immediately transferred to the database INSERT statement</li>
<li>What is happening here?</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              43/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>What was happening?</h2></header>
            
            
            <section><ul class="simple">
<li>gevent worker is really bad for CPU-bound applications</li>
<li>Makes I/O <strong>look</strong> expensive</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>gevent worker is intended for long-polling applications, when you need to open lots of inactive HTTP connections</li>
<li>This can be really bad for CPU-bound applications that open and close lots of connections</li>
<li>Can make I/O look expensive, when the real problem is each thread is trying to process too many requests at once</li>
<li>The Linux kernel is really good at pre-emptive multitasking.  You should let it do its job and use the sync worker for CPU bound applications.</li>
<li>Moving on, now we have a new problem...</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              44/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Database Reponse Time</h2></header>
            
            
            <section><img alt="static/nr2/dashboard-crash.png" class="align-center" src="static/nr2/dashboard-crash.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>As you can see, DB response time sky rockets, and the server eventually crashes before the test is complete</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              45/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Database Falls Over</h2></header>
            
            
            <section><img alt="static/nr2/pg-crash.png" class="align-center" src="static/nr2/pg-crash.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Here's a screenshot of TOP immediately before the crash; lots of defunct postgres processes and a load average of 182.</li>
<li>Not good.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              46/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Database Still Overloaded</h2></header>
            
            
            <section><img alt="static/nr3/sample3.png" class="align-center" src="static/nr3/sample3.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Increased database server size by several orders of magnitude - 68 GB of ram and 26 EC2 compute units</li>
<li>DB server still slow and overloaded.. what is wrong?</li>
<li>Went back and checked the math..</li>
<li>Oops.. we're load testing 3x our target, swamping the servers with requests they can't process</li>
<li>Make yourself a spreadsheet upfront so you don't make the same mistake I did</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              47/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>The Right Target Load</h2></header>
            
            
            <section><img alt="static/nr4/sample4.png" class="align-center" src="static/nr4/sample4.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>database server response time is nice and fast</li>
<li>redis is taking up more time than the DB again</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              48/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>HTTP Requests</h2></header>
            
            
            <section><img alt="static/nr4/dashboard-pre-final.png" class="align-center" src="static/nr4/dashboard-pre-final.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>target reqs/min are right where we want at 75,000</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              49/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>PostgreSQL Transactions</h2></header>
            
            
            <section><img alt="static/nr4/pg-transactions.png" class="align-center" src="static/nr4/pg-transactions.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>postgresql master transactions hit over 9,500 per second</li>
<li>the majority of them writes</li>
<li>wow!</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              50/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Recreate from Scratch, Test Again</h2></header>
            
            
            <section><ul class="simple">
<li>Recreated all servers from scratch</li>
<li>Response time was no where near what it was before</li>
<li>Postgres could barely hit 6,000 transactions/second</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Just to check everything, recreated all the servers</li>
<li>Did this because everything needs to be automated, needed to verify same performance</li>
<li>Performance dropped significantly</li>
<li>Discovered a couple database server configuration changes I neglected to add to version control</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              51/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Optimizing your PostgreSQL config</h2></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Before getting to those, a couple notes on optimizing your pg config in general</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              52/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Optimizing PostgreSQL: Where to Start</h2></header>
            
            
            <section><ul class="simple">
<li><a class="reference external" href="http://thebuild.com/presentations/not-your-job.pdf">Postgres When It's Not Your Job</a> (Christophe Pettus)</li>
<li><a class="reference external" href="http://media.revsys.com/talks/djangocon/2011/secrets-of-postgresql-performance.pdf">Secrets of PostgreSQL Performance</a> (Frank Wiles)</li>
<li>pgtune</li>
<li><a class="reference external" href="http://cakt.us/pg-tuning">http://cakt.us/pg-tuning</a></li>
<li><a class="reference external" href="http://cakt.us/pg-conns">http://cakt.us/pg-conns</a></li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Optimizing your Postgres config is a topic until itself</li>
<li>Our conference chair christophe gave an excellent talk last year titled Postgres When It's Not your Job.  You should get the slides and read them - it's amazing.</li>
<li>If you're looking for something quick, pgtune can be used to generate some sane defaults for a number of postgres config options</li>
<li>The last two links are to the Postgres wiki; they provide a lot of valuable discussion about different config options and how they interact</li>
<li>I'll also share a couple things we found which either aren't covered or are important enough to bring up again.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              53/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Figuring out max_connections</h2></header>
            
            
            <section><ul class="simple">
<li>Base max_connections on database server resources, not web server count</li>
<li>Use pgbouncer to share a small number of persistent connections</li>
<li>Run pgbouncer on your web servers using <tt class="docutils literal">supervisord</tt></li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>First, max_connections are an often mis-understood topic</li>
<li>After a point, the more your database server is doing at once, the longer it takes for <strong>every</strong> task</li>
<li>The right value for this setting is determined by machine resouces, NOT how many connections you think you need to open</li>
<li>Again, you can use transaction-level isolation in pgbouncer to share 2-3 connections across 30 web processes with no loss of performance</li>
<li>Even if you don't set max_connections this low, make sure you're limiting the connections through some other means such as pgbouncer</li>
<li>If you're already using supervisord, it's an easy addition to run pgbouncer to your config (rather than mucking around with files in /etc/)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              54/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>What was this talk about again?</h2></header>
            
            
            <section><p>Optimizing <tt class="docutils literal">postgresql.conf</tt> for heavy <tt class="docutils literal">INSERT</tt> load:</p>
<ul class="simple">
<li><strong>commit_delay = 4000</strong> - delay each commit this many microseconds in case we can do a group commit</li>
<li><strong>commit_siblings = 5</strong> - only delay if at least N transactions are in process</li>
</ul>
<p>(Note: this is now even better in PostgreSQL 9.2: <a class="reference external" href="http://cakt.us/pg-group-commit">http://cakt.us/pg-group-commit</a>)</p>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Lastly, there's rarely a magic bullet in server configuration, but this turned out to be it for us.</li>
<li>commit_delay - Rarely helps, but when it does, it helps a lot (and write-intensive applications are the perfect time to use it).</li>
<li>It works by sleeping for a set number of microseconds immediately before syncing to disk</li>
<li>When it wakes up, it checks to see if any other transactions are also sleeping before syncing</li>
<li>It &quot;takes over&quot; all sleeping transactions, syncing their data to disk at the same time as its own</li>
<li>When a transaction wakes up, it checks to see if it's already been sync'ed, and if it has, it returns immediately to the user</li>
<li>While this can make everything slower, but setting commit_siblings to a resonable value can make sure it only impacts performance when there might be something to be gained.</li>
<li>Arrived at these values through trial and error and by reading this post.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              55/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Final Tweaks</h2></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              56/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>The Right Target Load</h2></header>
            
            
            <section><img alt="static/nr4/sample4.png" class="align-center" src="static/nr4/sample4.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>You'll also notice on the last load test for survey_change_page that redis is taking up a significant amount of time</li>
<li>We were still using redis for both cache and sessions at this point, and discovered that it was using near 100% of a single core on the cache server.</li>
<li>Redis unfortunately is single threaded, so we swapped in memcached for the cache and continued to use redis for sessions (since it is persistent while memcached is not)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              57/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>survey_change_page, with memcached</h2></header>
            
            
            <section><img alt="static/nr5/sample5.png" class="align-center" src="static/nr5/sample5.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>So after we made those changes, redis disappeared from the graph and memcached took up a much more consistent chuck of the total time.</li>
<li>It was also evident from the server that memcached would have no trouble saturating additional CPU cores as needed.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              58/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Final Performance</h2></header>
            
            
            <section><img alt="static/nr5/dashboard-final.png" class="align-center" src="static/nr5/dashboard-final.png" />



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Once again, we'd hit the necessary 75,000 requests per minute, and all the servers could be easily recreated from scratch</li>
<li>For this load we ended up using about 16 extra large, high CPU instances for web servers</li>
</ul>
<p>---</p>

<h2>That's all!</h2>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              59/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Questions?</h2></header>
            
            
            <section><ul class="simple">
<li>Tobias McNulty</li>
<li>Twitter: <a class="reference external" href="https://twitter.com/tobiasmcnulty">&#64;tobiasmcnulty</a></li>
<li>Hire us: <a class="reference external" href="http://www.caktusgroup.com">http://www.caktusgroup.com</a></li>
<li>Slides: <a class="reference external" href="http://cakt.us/djangocon-scaling">http://cakt.us/djangocon-scaling</a></li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>Thanks everyone for your time today - I think we have a few minutes left for questions</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              60/61
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: /home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>The NoSQL Slide</h2></header>
            
            
            <section><p>PostgreSQL:</p>
<ul class="simple">
<li><strong>synchronous_commit = off</strong> - don't wait for fsync before returning success</li>
</ul>



</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul class="simple">
<li>We did think about that but after load testing with postgres we discovered it wasn't necessary</li>
<li>One useful option that can be handy if you don't care about the durability of a transaction is synchronous_commit</li>
<li>It's not as bad as disabling fsync b/c there's no risk of data inconsistency</li>
<li>But IF the server crashes BEFORE it can call fsync but AFTEr it returns success to the user, there might be an inconsistency between what the user thinks was saved and what was actually saved.</li>
<li>Obviously this is not good for banking transactions, but there are plenty of other less critical applications out there that might benefit from disabling this feature in Postgres.</li>
<li>We did not use this in the survey app because commit_delay got us where we needed to be.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst">/home/tobias/caktus/talks/djangocon/2013/scaling/scaling.rst</a>
            </aside>
            
            <aside class="page_number">
              61/61
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Scaling Your Write-Heavy Django App: A Case Study</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
        
        <tr id="toc-row-2" class="sub">
          <th><a href="#slide2">About Me</a></th>
          <td><a href="#slide2">2</a></td>
        </tr>
        
        <tr id="toc-row-3" class="sub">
          <th><a href="#slide3">Talk Outline</a></th>
          <td><a href="#slide3">3</a></td>
        </tr>
        
        <tr id="toc-row-4" class="sub">
          <th><a href="#slide4">Project Overview</a></th>
          <td><a href="#slide4">4</a></td>
        </tr>
        
        <tr id="toc-row-5" class="sub">
          <th><a href="#slide5">5Essentials Schools Surveys</a></th>
          <td><a href="#slide5">5</a></td>
        </tr>
        
        <tr id="toc-row-6" class="sub">
          <th><a href="#slide6">From Scantron...</a></th>
          <td><a href="#slide6">6</a></td>
        </tr>
        
        <tr id="toc-row-7" class="sub">
          <th><a href="#slide7">About the Project</a></th>
          <td><a href="#slide7">7</a></td>
        </tr>
        
        <tr id="toc-row-8" class="sub">
          <th><a href="#slide8">...to Scalable Web App</a></th>
          <td><a href="#slide8">8</a></td>
        </tr>
        
        <tr id="toc-row-9" class="sub">
          <th><a href="#slide9">Survey Composition</a></th>
          <td><a href="#slide9">9</a></td>
        </tr>
        
        <tr id="toc-row-10" class="sub">
          <th><a href="#slide10">Write-heavy App</a></th>
          <td><a href="#slide10">10</a></td>
        </tr>
        
        <tr id="toc-row-11" class="sub">
          <th><a href="#slide11">Fast or Scalable?</a></th>
          <td><a href="#slide11">11</a></td>
        </tr>
        
        <tr id="toc-row-12" class="sub">
          <th><a href="#slide12">Architecture</a></th>
          <td><a href="#slide12">12</a></td>
        </tr>
        
        <tr id="toc-row-13" class="sub">
          <th><a href="#slide13">Systems Diagram</a></th>
          <td><a href="#slide13">13</a></td>
        </tr>
        
        <tr id="toc-row-14" class="sub">
          <th><a href="#slide14">Scaling Phase I: Chicago Public Schools</a></th>
          <td><a href="#slide14">14</a></td>
        </tr>
        
        <tr id="toc-row-15" class="sub">
          <th><a href="#slide15">Phase I Scaling Target</a></th>
          <td><a href="#slide15">15</a></td>
        </tr>
        
        <tr id="toc-row-16" class="sub">
          <th><a href="#slide16">Step 1: django-debug-toolbar</a></th>
          <td><a href="#slide16">16</a></td>
        </tr>
        
        <tr id="toc-row-17" class="sub">
          <th><a href="#slide17">Step 1: Common query reduction patterns</a></th>
          <td><a href="#slide17">17</a></td>
        </tr>
        
        <tr id="toc-row-18" class="sub">
          <th><a href="#slide18">Step 2: Automate some load</a></th>
          <td><a href="#slide18">18</a></td>
        </tr>
        
        <tr id="toc-row-19" class="sub">
          <th><a href="#slide19">Step 3: pgfouine</a></th>
          <td><a href="#slide19">19</a></td>
        </tr>
        
        <tr id="toc-row-20" class="sub">
          <th><a href="#slide20">Step 3: pgfouine</a></th>
          <td><a href="#slide20">20</a></td>
        </tr>
        
        <tr id="toc-row-21" class="sub">
          <th><a href="#slide21">Step 4: Let's play cache</a></th>
          <td><a href="#slide21">21</a></td>
        </tr>
        
        <tr id="toc-row-22" class="sub">
          <th><a href="#slide22">Step 4: django-cache-machine</a></th>
          <td><a href="#slide22">22</a></td>
        </tr>
        
        <tr id="toc-row-23" class="sub">
          <th><a href="#slide23">Step 4: django-cache-machine</a></th>
          <td><a href="#slide23">23</a></td>
        </tr>
        
        <tr id="toc-row-24" class="sub">
          <th><a href="#slide24">Step 4: pgfouine, before</a></th>
          <td><a href="#slide24">24</a></td>
        </tr>
        
        <tr id="toc-row-25" class="sub">
          <th><a href="#slide25">Step 4: pgfouine, after</a></th>
          <td><a href="#slide25">25</a></td>
        </tr>
        
        <tr id="toc-row-26" class="sub">
          <th><a href="#slide26">Step 5: Multiple databases</a></th>
          <td><a href="#slide26">26</a></td>
        </tr>
        
        <tr id="toc-row-27" class="sub">
          <th><a href="#slide27">Step 5: django-balancer</a></th>
          <td><a href="#slide27">27</a></td>
        </tr>
        
        <tr id="toc-row-28" class="sub">
          <th><a href="#slide28">Step 5: Custom database router</a></th>
          <td><a href="#slide28">28</a></td>
        </tr>
        
        <tr id="toc-row-29" class="sub">
          <th><a href="#slide29">Step 6: Static Media</a></th>
          <td><a href="#slide29">29</a></td>
        </tr>
        
        <tr id="toc-row-30" class="sub">
          <th><a href="#slide30">Step 7: Automated Server Provisioning</a></th>
          <td><a href="#slide30">30</a></td>
        </tr>
        
        <tr id="toc-row-31" class="sub">
          <th><a href="#slide31">Review of Phase I</a></th>
          <td><a href="#slide31">31</a></td>
        </tr>
        
        <tr id="toc-row-32" class="sub">
          <th><a href="#slide32">Review of Phase I</a></th>
          <td><a href="#slide32">32</a></td>
        </tr>
        
        <tr id="toc-row-33" class="sub">
          <th><a href="#slide33">Scaling Phase II: The State of Illinois</a></th>
          <td><a href="#slide33">33</a></td>
        </tr>
        
        <tr id="toc-row-34" class="sub">
          <th><a href="#slide34">Phase II Scaling Target</a></th>
          <td><a href="#slide34">34</a></td>
        </tr>
        
        <tr id="toc-row-35" class="sub">
          <th><a href="#slide35">Interlude: Postgres-XC</a></th>
          <td><a href="#slide35">35</a></td>
        </tr>
        
        <tr id="toc-row-36" class="sub">
          <th><a href="#slide36">Why load test?</a></th>
          <td><a href="#slide36">36</a></td>
        </tr>
        
        <tr id="toc-row-37" class="sub">
          <th><a href="#slide37">Before we start</a></th>
          <td><a href="#slide37">37</a></td>
        </tr>
        
        <tr id="toc-row-38" class="sub">
          <th><a href="#slide38">Server Diagram</a></th>
          <td><a href="#slide38">38</a></td>
        </tr>
        
        <tr id="toc-row-39" class="sub">
          <th><a href="#slide39">Spreadsheet</a></th>
          <td><a href="#slide39">39</a></td>
        </tr>
        
        <tr id="toc-row-40" class="sub">
          <th><a href="#slide40">Generating load at scale</a></th>
          <td><a href="#slide40">40</a></td>
        </tr>
        
        <tr id="toc-row-41" class="sub">
          <th><a href="#slide41">survey_change_page, gevent</a></th>
          <td><a href="#slide41">41</a></td>
        </tr>
        
        <tr id="toc-row-42" class="sub">
          <th><a href="#slide42">What's going on?</a></th>
          <td><a href="#slide42">42</a></td>
        </tr>
        
        <tr id="toc-row-43" class="sub">
          <th><a href="#slide43">survey_change_page, sync</a></th>
          <td><a href="#slide43">43</a></td>
        </tr>
        
        <tr id="toc-row-44" class="sub">
          <th><a href="#slide44">What was happening?</a></th>
          <td><a href="#slide44">44</a></td>
        </tr>
        
        <tr id="toc-row-45" class="sub">
          <th><a href="#slide45">Database Reponse Time</a></th>
          <td><a href="#slide45">45</a></td>
        </tr>
        
        <tr id="toc-row-46" class="sub">
          <th><a href="#slide46">Database Falls Over</a></th>
          <td><a href="#slide46">46</a></td>
        </tr>
        
        <tr id="toc-row-47" class="sub">
          <th><a href="#slide47">Database Still Overloaded</a></th>
          <td><a href="#slide47">47</a></td>
        </tr>
        
        <tr id="toc-row-48" class="sub">
          <th><a href="#slide48">The Right Target Load</a></th>
          <td><a href="#slide48">48</a></td>
        </tr>
        
        <tr id="toc-row-49" class="sub">
          <th><a href="#slide49">HTTP Requests</a></th>
          <td><a href="#slide49">49</a></td>
        </tr>
        
        <tr id="toc-row-50" class="sub">
          <th><a href="#slide50">PostgreSQL Transactions</a></th>
          <td><a href="#slide50">50</a></td>
        </tr>
        
        <tr id="toc-row-51" class="sub">
          <th><a href="#slide51">Recreate from Scratch, Test Again</a></th>
          <td><a href="#slide51">51</a></td>
        </tr>
        
        <tr id="toc-row-52" class="sub">
          <th><a href="#slide52">Optimizing your PostgreSQL config</a></th>
          <td><a href="#slide52">52</a></td>
        </tr>
        
        <tr id="toc-row-53" class="sub">
          <th><a href="#slide53">Optimizing PostgreSQL: Where to Start</a></th>
          <td><a href="#slide53">53</a></td>
        </tr>
        
        <tr id="toc-row-54" class="sub">
          <th><a href="#slide54">Figuring out max_connections</a></th>
          <td><a href="#slide54">54</a></td>
        </tr>
        
        <tr id="toc-row-55" class="sub">
          <th><a href="#slide55">What was this talk about again?</a></th>
          <td><a href="#slide55">55</a></td>
        </tr>
        
        <tr id="toc-row-56" class="sub">
          <th><a href="#slide56">Final Tweaks</a></th>
          <td><a href="#slide56">56</a></td>
        </tr>
        
        <tr id="toc-row-57" class="sub">
          <th><a href="#slide57">The Right Target Load</a></th>
          <td><a href="#slide57">57</a></td>
        </tr>
        
        <tr id="toc-row-58" class="sub">
          <th><a href="#slide58">survey_change_page, with memcached</a></th>
          <td><a href="#slide58">58</a></td>
        </tr>
        
        <tr id="toc-row-59" class="sub">
          <th><a href="#slide59">Final Performance</a></th>
          <td><a href="#slide59">59</a></td>
        </tr>
        
        <tr id="toc-row-60" class="sub">
          <th><a href="#slide60">Questions?</a></th>
          <td><a href="#slide60">60</a></td>
        </tr>
        
        <tr id="toc-row-61" class="sub">
          <th><a href="#slide61">The NoSQL Slide</a></th>
          <td><a href="#slide61">61</a></td>
        </tr>
        
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15492387-10']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
</body>
</html>